// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model TuitionCentre {
  id                  String                 @id @default(uuid())
  name                String
  location            String
  whatsappNumber      String
  website             String?
  dataQualityStatus   String                 @default("OK") // OK or NEEDS_REVIEW
  dataQualityNotes    String?                // Details about data quality issues
  levels              TuitionCentreLevel[]
  subjects            TuitionCentreSubject[]
  offerings           Offering[]             // Explicit level-subject combinations
  discussionThread    DiscussionThread?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  @@index([name])
  @@index([location])
  @@index([dataQualityStatus])
}

model Level {
  id             String               @id @default(uuid())
  name           String               @unique
  tuitionCentres TuitionCentreLevel[]
  offerings      Offering[]
  createdAt      DateTime             @default(now())
}

model Subject {
  id             String                 @id @default(uuid())
  name           String                 @unique
  tuitionCentres TuitionCentreSubject[]
  offerings      Offering[]
  createdAt      DateTime               @default(now())
}

model TuitionCentreLevel {
  tuitionCentreId String
  levelId         String
  tuitionCentre   TuitionCentre @relation(fields: [tuitionCentreId], references: [id], onDelete: Cascade)
  level           Level         @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@id([tuitionCentreId, levelId])
}

model TuitionCentreSubject {
  tuitionCentreId String
  subjectId       String
  tuitionCentre   TuitionCentre @relation(fields: [tuitionCentreId], references: [id], onDelete: Cascade)
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@id([tuitionCentreId, subjectId])
}

// Offering represents an explicit level-subject combination offered by a centre
// This ensures that level + subject filters match on the same offering row
model Offering {
  id              String        @id @default(uuid())
  tuitionCentreId String
  levelId         String
  subjectId       String
  tuitionCentre   TuitionCentre @relation(fields: [tuitionCentreId], references: [id], onDelete: Cascade)
  level           Level         @relation(fields: [levelId], references: [id], onDelete: Cascade)
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([tuitionCentreId, levelId, subjectId])
  @@index([tuitionCentreId])
  @@index([levelId])
  @@index([subjectId])
}

enum UserRole {
  PARENT
  CENTRE
  ADMIN
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  username     String?   @unique
  role         UserRole  @default(PARENT)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  comments     Comment[]

  @@index([email])
  @@index([username])
}

model DiscussionThread {
  id              String         @id @default(uuid())
  tuitionCentreId String         @unique
  tuitionCentre   TuitionCentre  @relation(fields: [tuitionCentreId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())
  comments        Comment[]

  @@index([tuitionCentreId])
}

model Comment {
  id                 String           @id @default(uuid())
  discussionThreadId String
  discussionThread   DiscussionThread @relation(fields: [discussionThreadId], references: [id], onDelete: Cascade)
  authorId           String?
  author             User?            @relation(fields: [authorId], references: [id], onDelete: SetNull)
  body               String
  isAnonymous        Boolean          @default(false)
  isHidden           Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([discussionThreadId, createdAt])
  @@index([isHidden])
}
